package com.example.meraki.controllers;

import com.example.meraki.common.createrequests.CreateSellBatchRequestDTO;
import com.example.meraki.common.createrequests.CreateSellVoucherRequestDTO;
import com.example.meraki.common.createrequests.CreateVoucherRequestDTO;
import com.example.meraki.common.createrequests.CreateVoucherRequestVerificationDTO;
import com.example.meraki.common.misc.UserLoginRequestDTO;
import com.example.meraki.common.updaterequests.UpdateVoucherRequestDTO;
import com.example.meraki.controllers.BatchDTO.BatchDTO;
import com.example.meraki.controllers.BatchDTO.BatchDetailDTO;
import com.example.meraki.controllers.UserDTO.UserDTO;
import com.example.meraki.controllers.bundlesDTO.BundlesDTO;
import com.example.meraki.controllers.currencyDTO.CurrencyDTO;
import com.example.meraki.controllers.vouchersDTO.*;
import com.example.meraki.entities.Batch;
import com.example.meraki.entities.Bundles;
import com.example.meraki.entities.User;
import com.example.meraki.entities.Vouchers;
import com.example.meraki.repositories.VouchersRepository;
import com.example.meraki.services.BatchService;
import com.example.meraki.services.BundlesService;
import com.example.meraki.services.UserService;
import com.example.meraki.services.VouchersService;
import com.example.meraki.services.response.*;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import lombok.AllArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;
import java.util.List;

import static java.util.stream.Collectors.toList;

@RestController
@AllArgsConstructor
public class VouchersController {
    @Autowired
    private UserService userService;

    @Autowired
    private BundlesService bundlesService;

    @Autowired
    private VouchersService voucherService;

    @Autowired
    private BatchService batchService;

    @Autowired
    private VouchersRepository vouchersRepository;


    @CrossOrigin
    @GetMapping(path = "/voucher/", produces = MediaType.APPLICATION_JSON_VALUE)
    @ApiOperation(value = "batches?=true/false", produces = MediaType.APPLICATION_JSON_VALUE)
    public Response<List<Vouchers>> listVouchersBatch(
    ) {
        List<Vouchers> vouchers;

        vouchers = voucherService.getAllVouchers();

        return new Response<>(ResponseCode.SUCCESS, "OK", vouchers);
    }

    @CrossOrigin
    @GetMapping(path = "/voucher/{batchId}", produces = MediaType.APPLICATION_JSON_VALUE)
    @ApiOperation(value = "Retrieve a voucher using  batch Id.", produces = MediaType.APPLICATION_JSON_VALUE)

    public Response<List<VoucherBatchDetailDTO>> getByBatchId(
            @ApiParam(value = "Id of batch", example = "1", required = true)
            @PathVariable Long batchId) {

        if (voucherService.checkVoucherExistsInBatch(batchId, this.batchService)) {
            return new Response<>(ResponseCode.NOT_FOUND, "No batch find", null);
        } else {
            List<Vouchers> voucherResult = voucherService.getVoucherByBatchId(batchService.getBatch(batchId));
            List<VoucherBatchDetailDTO> payload = voucherResult.stream().map(this::getVoucherDetail).collect(toList());
            return new Response<>(ResponseCode.SUCCESS, "OK", payload);
        }
    }

    /*@CrossOrigin
    @GetMapping(path = "/voucher/{name}", produces = MediaType.APPLICATION_JSON_VALUE)
    @ApiOperation(value = "Retrieve a voucher batch by name.", produces = MediaType.APPLICATION_JSON_VALUE)
    public Response<List<Vouchers>> getVoucherByBatchName(
            @ApiParam(value = "batch-name of the voucher", example = "Telone", required = true)
            @PathVariable String name) {
        return new Response<>(ResponseCode.SUCCESS, "OK", voucherList);

    }*/

    @CrossOrigin
    @PutMapping("/voucher/{id}")
    @ApiParam(value = "update voucher", example = "", required = true)
    public Response<UpdateVoucherResponse> updateVoucherBatchStage(
            @RequestBody UpdateVoucherRequestDTO updateVoucherRequestDTO) {
        UpdateVoucherResponse response = voucherService.updateVoucher(updateVoucherRequestDTO);
        return new Response<>(ResponseCode.SUCCESS, "Ok", response);
    }


    @CrossOrigin
    @PostMapping(path = "/voucher/sell-batch/", consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)
    @ApiOperation(value = "sellByBatchId", consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)
    public Response<CreateSellBatchResponse> createSellVoucherBatchId(@RequestBody CreateSellBatchRequestDTO createSellBatchRequestDTO) {

        CreateSellBatchResponse createSellBatchResponse = batchService.createBatch(createSellBatchRequestDTO);

        return new Response<>(ResponseCode.SUCCESS, "Batch added.", createSellBatchResponse);

    }

    @CrossOrigin
    @PostMapping(path = "/voucher/sell-voucher/", consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)
    @ApiOperation(value = "sellVoucherById", consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)
    public Response<SellVoucherDetailDTO> createSellVoucherByVoucherId(@RequestBody CreateSellVoucherRequestDTO createSellVoucherRequestDTO) {

        SellVoucherDetailDTO sellVoucherDetailDTO = null;
        try {
            CreateSellVoucherResponse createSellVoucherResponse = voucherService.createSellVoucherByVoucherId(createSellVoucherRequestDTO);
            sellVoucherDetailDTO = new SellVoucherDetailDTO(
                    SellVouchersDTO.fromSellVoucher(voucherService.getVoucher(createSellVoucherRequestDTO.getId()))
                    //UserDTO.fromUser(userService.getUser(createSellVoucherRequestDTO.getUserID()))
            );

        } catch (IOException e) {

        }
        return new Response<>(ResponseCode.SUCCESS, "sell-voucher added.", sellVoucherDetailDTO);

    }

    @CrossOrigin
    @PostMapping(path = "/voucher/", consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)
    @ApiOperation(value = "sell-batch", consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)
    private Response<VoucherDetailDTO> CreateVoucherBatch(@RequestBody CreateVoucherRequestDTO createVoucherRequestDTO) {


        VoucherDetailDTO voucherDetailDTO = null;
        try {
            CreateVoucherResponse createVoucherResponse = voucherService.createVoucherBatch(createVoucherRequestDTO);
            voucherDetailDTO = new VoucherDetailDTO(
                    VouchersDTO.fromVoucher(createVoucherResponse.getVouchers()),
                    UserDTO.fromUser(userService.getUser(createVoucherRequestDTO.getUserID())),
                    BundlesDTO.fromBundles(bundlesService.getBundle(createVoucherRequestDTO.getBundleID())),
                    BatchDTO.fromBatch(batchService.getBatch(createVoucherRequestDTO.getBatchID()))

            );

        } catch (IOException e) {

        }
        return new Response<>(ResponseCode.SUCCESS, "Voucher was added.", voucherDetailDTO);
    }

    @CrossOrigin
    @PostMapping(path = "/voucher/verify/", produces = MediaType.APPLICATION_JSON_VALUE)
    @ApiOperation(value = "Verify voucher", produces = MediaType.APPLICATION_JSON_VALUE)
    public Response<CreateVoucherVerificationResponse> verifyCode(
            @ApiParam(value = "verify code")
            @RequestBody CreateVoucherRequestVerificationDTO vouchers) {

        CreateVoucherVerificationResponse payload;


        if (vouchersRepository.existsByVoucherCode(vouchers.getVoucherCode())) {

            payload = voucherService.voucherResponse(vouchers);

            return new Response<>(ResponseCode.SUCCESS, "Voucher verified", payload);


        } else {
            return new Response<>(ResponseCode.NOT_FOUND, "Voucher doesn't exist", null);
        }
    }


    private VoucherBatchDetailDTO getVoucherDetail(Vouchers vouchers) {
        User user = userService.getUser(vouchers.getUser().getId());
        Bundles bundles = bundlesService.getBundle(vouchers.getBundle().getId());
        //
        //bundlesService.getBundle(vouchers.getId());
        Batch batch = batchService.getBatch(vouchers.getBatch().getId());

        return new VoucherBatchDetailDTO(VouchersDTO.fromVoucher(vouchers),
                UserDTO.fromUser(user),
                BundlesDTO.fromBundles(bundles),
                BatchDTO.fromBatch(batch)
        );

    }
}
        //
        //
        //
        //
        //
        //
        //





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































